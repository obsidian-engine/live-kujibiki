<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>é…ä¿¡ç”¨ãã˜å¼•ã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              'noto': ['Noto Sans JP', 'Inter', 'system-ui', '-apple-system', 'sans-serif']
            }
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .tab-btn {
        color: #6b7280;
        background-color: transparent;
      }
      .tab-btn.active {
        color: #1f2937;
        background-color: #f3f4f6;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-noto">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">ğŸ² é…ä¿¡ç”¨ãã˜å¼•ã</h1>
      </div>

      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <nav class="flex justify-center mb-8" role="tablist">
        <div class="bg-white rounded-xl shadow-sm p-1 inline-flex">
          <button 
            id="playTab" 
            class="tab-btn active px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            role="tab" 
            aria-selected="true" 
            aria-controls="play-panel"
            onclick="switchTab('play')"
          >
            ğŸ® <span class="hidden sm:inline ml-1">ã‚²ãƒ¼ãƒ </span>
          </button>
          <button 
            id="masterTab" 
            class="tab-btn px-6 py-3 rounded-lg font-medium text-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            role="tab" 
            aria-selected="false" 
            aria-controls="master-panel"
            onclick="switchTab('master')"
          >
            ğŸ› ï¸ <span class="hidden sm:inline ml-1">è¨­å®š</span>
          </button>
        </div>
      </nav>

      <!-- ã‚²ãƒ¼ãƒ ã‚¿ãƒ– -->
      <div id="play-panel" class="tab-content active" role="tabpanel" aria-labelledby="playTab">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
          <!-- å‚åŠ è€…æƒ…å ±è¡¨ç¤º -->
          <div class="mb-6 text-center">
            <div class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">
              å‚åŠ è€…: <span id="playersView" class="text-blue-600">-</span>äºº | 
              ç¾åœ¨: <span id="currentView" class="text-green-600">-</span> | 
              æ®‹ã‚Š: <span id="remainView" class="text-red-600">-</span>å€‹
            </div>
            <div class="text-sm text-gray-500 space-y-1">
              <div>
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100">
                  Room: <span id="roomIdView" class="ml-1 font-medium">-</span>
                </span>
              </div>
              <div>
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700">
                  ä¸Šé™: <span class="ml-1 font-medium">10å€‹</span>
                </span>
              </div>
            </div>
          </div>
          

          <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
          <div class="flex flex-wrap gap-3 justify-center mb-6">
            <button id="drawBtn" class="disabled px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              ğŸ² 1ä»¶ å¼•ã
            </button>
            <button id="ackBtn" class="disabled px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
              âœ… ç¢ºèªå®Œäº†
            </button>
            <button id="resetRoundBtn" class="disabled px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
              ğŸ”„ ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>

          <!-- çµæœè¡¨ç¤º -->
          <div id="display" class="bg-gradient-to-r from-indigo-50 to-blue-50 border-2 border-indigo-200 rounded-2xl p-8 text-center text-3xl md:text-5xl font-extrabold text-gray-800 min-h-[120px] flex items-center justify-center shadow-inner">
            Ready
          </div>

          <!-- ç¾åœ¨ã®ãŠé¡Œä¸€è¦§ -->
          <div class="mt-6 bg-gray-50 rounded-xl p-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
              ğŸ“‹ ç¾åœ¨ã®ãŠé¡Œä¸€è¦§
              <span id="gameTabTopicCount" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0ä»¶</span>
            </h3>
            <div id="gameTabMasterList" class="bg-white rounded-lg p-4 text-sm max-h-40 overflow-y-auto border border-gray-200 min-h-[60px] flex items-center justify-center text-gray-500">
              ãŠé¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
            </div>
          </div>

          <!-- éè¡¨ç¤ºãƒœã‚¿ãƒ³ -->
          <button
            id="resetAllBtn"
            class="disabled hidden"
            style="background: #fee; border: 1px solid #f88;"
          >
            å…¨éƒ¨åˆæœŸåŒ–
          </button>
          <div class="hidden">
            <button data-setp="4" class="disabled">4äººã«ã™ã‚‹</button>
            <button data-setp="5" class="disabled">5äººã«ã™ã‚‹</button>
            <button data-setp="6" class="disabled">6äººã«ã™ã‚‹</button>
            <button data-setp="7" class="disabled">7äººã«ã™ã‚‹</button>
          </div>
        </div>
      </div>

      <!-- Masterè¨­å®šã‚¿ãƒ– -->
      <div id="master-panel" class="tab-content" role="tabpanel" aria-labelledby="masterTab">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
          <div class="max-w-2xl mx-auto">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800 mb-3">ğŸ› ï¸ ãŠé¡Œè¨­å®š</h2>
              <p class="text-gray-600 text-sm">
                åˆå›ã ã‘Masterã«7ä»¶ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚<br />
                â€» Masterå…¥åŠ›å¾Œã¯è‡ªå‹•ã§Listã¸å±•é–‹ã•ã‚Œã¾ã™ã€‚
              </p>
            </div>

            <div class="mb-6">
              <label for="masterInput" class="block text-sm font-medium text-gray-700 mb-2">
                ãŠé¡Œä¸€è¦§ã‚’å…¥åŠ›
              </label>
              <textarea
                id="masterInput"
                class="w-full h-36 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 resize-none"
                placeholder="ï¼ˆä¾‹ï¼‰&#10;ãƒªãƒ¼ãƒã‚’ã‹ã‘ã‚‹&#10;é³´ã‹ãªã„&#10;å­—ç‰Œã‚’ä½¿ã†&#10;ãƒ‰ãƒ©ã‚’ä½¿ã†&#10;ãƒ”ãƒ³ãƒ•ã§ã‚ãŒã‚‹&#10;ã‚¿ãƒ³ãƒ¤ã‚ªã§ã‚ãŒã‚‹&#10;2å›ä»¥ä¸Šé³´ã"
              ></textarea>
            </div>

            <div class="mb-6 flex justify-center">
              <button id="applyMasterBtn" class="disabled px-8 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                ğŸ“‹ Masterã‚’ç™»éŒ²ï¼ˆè‡ªå‹•å±•é–‹ï¼‰
              </button>
            </div>
            
            <!-- ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™è¨­å®š -->
            <div class="mb-6 bg-blue-50 rounded-xl p-4">
              <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                ğŸ“Š ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™è¨­å®š
              </h3>
              
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label for="maxDrawsPerRoundInput" class="block text-sm font-medium text-gray-700 mb-2">
                    1ãƒ©ã‚¦ãƒ³ãƒ‰æœ€å¤§æŠ½é¸æ•°
                  </label>
                  <input
                    type="number"
                    id="maxDrawsPerRoundInput"
                    min="0"
                    max="20"
                    value="0"
                    aria-describedby="drawLimitHelp"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  />
                  <p id="drawLimitHelp" class="text-xs text-gray-500 mt-1">1ãƒ©ã‚¦ãƒ³ãƒ‰æœ€å¤§æŠ½é¸æ•°ï¼ˆ0=ç„¡åˆ¶é™ã€1-20ï¼‰</p>
                  <p id="drawLimitError" class="text-xs text-red-600 mt-1 hidden"></p>
                </div>
                
                <div class="text-center text-sm text-gray-600">
                  <p><strong>ãŠé¡Œæ•°ä¸Šé™:</strong> 10å€‹ï¼ˆå›ºå®šï¼‰</p>
                </div>
              </div>
              
              <div class="mt-4 flex justify-center">
                <button id="applyLimitsBtn" class="disabled px-6 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  âš™ï¸ ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™ã‚’é©ç”¨
                </button>
              </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4">
              <h3 class="text-sm font-medium text-gray-700 mb-3">ç¾åœ¨ã®ãŠé¡Œä¸€è¦§:</h3>
              <div id="masterListDisplay" class="bg-white rounded-lg p-4 text-sm max-h-32 overflow-y-auto border border-gray-200">
                èª­ã¿è¾¼ã¿ä¸­...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" role="dialog" aria-labelledby="modalTitle" aria-describedby="modalDescription">
      <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md mx-4 transform transition-all duration-200 scale-95">
        <div class="text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 mb-4">
            <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 19c-.77.833.192 2.5 1.732 2.5z" />
            </svg>
          </div>
          <h3 id="modalTitle" class="text-lg font-semibold text-gray-900 mb-2">ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆç¢ºèª</h3>
          <p id="modalDescription" class="text-sm text-gray-600 mb-6">
            ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚<br>
            å¼•ã„ãŸãŠé¡Œã¯å…ƒã«æˆ»ã•ã‚Œã€æ¬¡ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã‹ã‚‰ã«ãªã‚Šã¾ã™ã€‚<br>
            ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
          </p>
          <div class="flex gap-3 justify-center">
            <button id="cancelReset" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button id="confirmReset" class="px-6 py-2 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2">
              ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Firebaseè¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ³¨å…¥ï¼ˆGitHub Actionsã§ç½®æ›ï¼‰
      window.FIREBASE_CONFIG = {
        apiKey: "__FIREBASE_API_KEY__",
        authDomain: "__FIREBASE_AUTH_DOMAIN__",
        projectId: "__FIREBASE_PROJECT_ID__",
        storageBucket: "__FIREBASE_STORAGE_BUCKET__",
        messagingSenderId: "__FIREBASE_MESSAGING_SENDER_ID__",
        appId: "__FIREBASE_APP_ID__",
        measurementId: "__FIREBASE_MEASUREMENT_ID__"
      };
    </script>
    <script>
      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
      function switchTab(tabName) {
        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ãƒ‘ãƒãƒ«ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
          btn.setAttribute('aria-selected', 'false');
        });
        document.querySelectorAll('.tab-content').forEach(panel => {
          panel.classList.remove('active');
        });

        // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const selectedTab = document.getElementById(tabName + 'Tab');
        const selectedPanel = document.getElementById(tabName + '-panel');
        
        if (selectedTab && selectedPanel) {
          selectedTab.classList.add('active');
          selectedTab.setAttribute('aria-selected', 'true');
          selectedPanel.classList.add('active');
        }
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
      function showConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('confirmReset').focus();
        
        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', handleModalEscape);
      }

      function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.removeEventListener('keydown', handleModalEscape);
      }

      function handleModalEscape(e) {
        if (e.key === 'Escape') {
          hideConfirmModal();
        }
      }

      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
      document.addEventListener('DOMContentLoaded', function() {
        const tabButtons = document.querySelectorAll('.tab-btn');
        
        tabButtons.forEach((btn, index) => {
          btn.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
              e.preventDefault();
              const nextIndex = e.key === 'ArrowLeft' ? 
                (index - 1 + tabButtons.length) % tabButtons.length :
                (index + 1) % tabButtons.length;
              tabButtons[nextIndex].click();
              tabButtons[nextIndex].focus();
            }
          });
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå¾Œã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰
        // resetRoundé–¢æ•°ãŒå®šç¾©ã•ã‚ŒãŸå¾Œã«è¨­å®šã•ã‚Œã‚‹

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('confirmModal').addEventListener('click', function(e) {
          if (e.target === this) {
            hideConfirmModal();
          }
        });
      });
    </script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        onSnapshot,
        runTransaction,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

      const firebaseConfig = window.FIREBASE_CONFIG;

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const qs = new URLSearchParams(location.search);
      const roomId = (qs.get("room") || "demo-room").trim();
      document.getElementById("roomIdView").textContent = roomId;
      const roomRef = doc(db, "rooms", roomId);

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
      const STORAGE_KEY = `liveKujibiki-master-${roomId}-v1`;

      const DEFAULT_STATE = {
        master: [],
        list: [],
        history: [],
        currentPlayer: 0,
        maxPlayers: 4,
        maxTopics: 10, // ãŠé¡Œæ•°ã®ä¸Šé™
        topicsWarningThreshold: 10, // è­¦å‘Šã‚’å‡ºã™æ®‹ã‚Šæ•°ã®é–¾å€¤
        maxDrawsPerRound: 0, // 1ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®æœ€å¤§æŠ½é¸æ•° (0=ç„¡åˆ¶é™)
        roundBuffer: [],
        display: "Ready",
        updatedAt: serverTimestamp(),
        version: 0,
      };

      function clamp(v, lo, hi) {
        return Math.min(hi, Math.max(lo, v));
      }

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰masterå€¤ã‚’å–å¾—
      function loadMasterFromStorage() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          console.warn("Failed to load master from localStorage:", e);
          return [];
        }
      }

      // masterå€¤ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      function saveMasterToStorage(master) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(master));
        } catch (e) {
          console.warn("Failed to save master to localStorage:", e);
        }
      }

      // masterè¡¨ç¤ºã‚’æ›´æ–°
      function updateMasterDisplay(master) {
        const displayEl = document.getElementById("masterListDisplay");
        const gameTabDisplayEl = document.getElementById("gameTabMasterList");
        const gameTabCountEl = document.getElementById("gameTabTopicCount");
        
        if (!master || master.length === 0) {
          // è¨­å®šã‚¿ãƒ–ã®è¡¨ç¤º
          if (displayEl) displayEl.textContent = "ã¾ã ãŠé¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“";
          
          // ã‚²ãƒ¼ãƒ ã‚¿ãƒ–ã®è¡¨ç¤º
          if (gameTabDisplayEl) gameTabDisplayEl.innerHTML = '<div class="text-center text-gray-500">ãŠé¡ŒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          if (gameTabCountEl) gameTabCountEl.textContent = "0ä»¶";
          return;
        }
        
        const masterListHTML = master.map((item, i) => `${i + 1}. ${item}`).join("<br>");
        
        // è¨­å®šã‚¿ãƒ–ã®è¡¨ç¤º
        if (displayEl) displayEl.innerHTML = masterListHTML;
        
        // ã‚²ãƒ¼ãƒ ã‚¿ãƒ–ã®è¡¨ç¤º
        if (gameTabDisplayEl) gameTabDisplayEl.innerHTML = masterListHTML;
        if (gameTabCountEl) gameTabCountEl.textContent = `${master.length}ä»¶`;
      }

      async function ensureRoom() {
        const snap = await getDoc(roomRef);
        if (!snap.exists()) {
          await setDoc(roomRef, DEFAULT_STATE);
        }
      }

      // â˜… MasterãŒã‚ã‚ŠListãŒç©ºãªã‚‰è‡ªå‹•å±•é–‹ï¼ˆMasterâ†’Listï¼‰
      async function autoPopulateFromMasterIfNeeded() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          if (!snap.exists()) return;
          const s = snap.data();
          const master = s.master || [];
          const list = s.list || [];
          if (master.length > 0 && list.length === 0) {
            tx.set(
              roomRef,
              {
                ...s,
                list: [...master],
                roundBuffer: [],
                currentPlayer: 0, // æ¬¡ã¯Player1ã‹ã‚‰ï¼ˆãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
                display: "Ready",
                updatedAt: serverTimestamp(),
                version: (s.version || 0) + 1,
              },
              { merge: true }
            );
          }
        });
      }

      // ==== UIå‚ç…§ ====
      const authStateEl = document.getElementById("authState");
      const displayEl = document.getElementById("display");
      const playersView = document.getElementById("playersView");
      const currentView = document.getElementById("currentView");
      const remainView = document.getElementById("remainView");

      const drawBtn = document.getElementById("drawBtn");
      const ackBtn = document.getElementById("ackBtn");
      const resetRoundBtn = document.getElementById("resetRoundBtn");
      const resetAllBtn = document.getElementById("resetAllBtn");
      const masterInput = document.getElementById("masterInput");
      const applyMasterBtn = document.getElementById("applyMasterBtn");
      const playerBtns = Array.from(document.querySelectorAll("[data-setp]"));
      const maxDrawsPerRoundInput = document.getElementById("maxDrawsPerRoundInput");
      const applyLimitsBtn = document.getElementById("applyLimitsBtn");

      function enableControls(enabled) {
        const method = enabled ? "remove" : "add";
        [
          // drawBtnã¯ç‹¬è‡ªåˆ¶å¾¡ã™ã‚‹ã®ã§é™¤å¤–
          ackBtn,
          resetRoundBtn,
          resetAllBtn,
          applyMasterBtn,
          applyLimitsBtn,
          ...playerBtns,
        ].forEach((el) => el.classList[method]("disabled"));
        
        // drawBtnã¯èªè¨¼çŠ¶æ…‹ã®ã¿ãƒã‚§ãƒƒã‚¯
        if (drawBtn) {
          if (enabled) {
            drawBtn.disabled = false;
          } else {
            drawBtn.disabled = true;
            drawBtn.classList.add("disabled");
          }
        }
      }

      // ==== Firestore Actions ====
      async function drawOne() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          const s = snap.exists() ? snap.data() : DEFAULT_STATE;

          let list = [...(s.list || [])];
          if (list.length === 0)
            throw new Error("ListãŒç©ºã§ã™ã€‚Masterã¸ãŠé¡Œã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");

          const maxP = clamp(Number(s.maxPlayers || 4), 1, 7);
          let current = Number(s.currentPlayer || 0);
          current = (current % maxP) + 1;

          // ãƒ©ã‚¦ãƒ³ãƒ‰æŠ½é¸æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
          const maxDrawsPerRound = Number(s.maxDrawsPerRound || 0);
          const roundBuffer = s.roundBuffer || [];
          if (maxDrawsPerRound > 0 && roundBuffer.length >= maxDrawsPerRound) {
            throw new Error(`1ãƒ©ã‚¦ãƒ³ãƒ‰ã®æŠ½é¸æ•°ä¸Šé™ï¼ˆ${maxDrawsPerRound}ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚`);
          }

          const idx = Math.floor(Math.random() * list.length);
          const picked = list.splice(idx, 1)[0];

          const newRoundBuffer = [...roundBuffer, picked];
          const history = [
            { t: new Date(), player: current, picked },
            ...(s.history || []),
          ].slice(0, 200);

          let display = `ğŸ® Player ${current} â†’ ${picked}`;
          let currentPlayer = current;
          let listAfter = list;
          let roundBufAfter = newRoundBuffer;

          if (current === maxP) {
            // Nå›ã§1ã‚²ãƒ¼ãƒ  â†’ æ¸›ã£ãŸåˆ†ã‚’å¾©å…ƒã—ã¦æ¬¡ã¯1ã¸
            listAfter = [...list, ...newRoundBuffer];
            roundBufAfter = [];
            currentPlayer = 0;
            display = `ğŸ”Player ${current} â†’ ${picked}`;
          }

          tx.set(
            roomRef,
            {
              ...s,
              list: listAfter,
              roundBuffer: roundBufAfter,
              history,
              currentPlayer,
              display,
              updatedAt: serverTimestamp(),
              version: (s.version || 0) + 1,
            },
            { merge: true }
          );
        });
      }

      // ã€ŒãŠé¡Œã‚’ç¢ºèªã—ã¾ã—ãŸã€â†’ è¡¨ç¤ºã‚’æ¶ˆã™ï¼ˆä¸­èº«ã¯ãã®ã¾ã¾ï¼‰
      async function acknowledgeDisplay() {
        await setDoc(
          roomRef,
          {
            display: "ï¼ˆç¢ºèªæ¸ˆãƒ»éè¡¨ç¤ºï¼‰",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      }

      // ãƒ©ã‚¦ãƒ³ãƒ‰æ‰‹å‹•å¾©å…ƒ
      async function resetRound() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          const s = snap.exists() ? snap.data() : DEFAULT_STATE;
          const restored = [...(s.list || []), ...(s.roundBuffer || [])];
          tx.set(
            roomRef,
            {
              ...s,
              list: restored,
              roundBuffer: [],
              currentPlayer: 0,
              display: "ğŸ² ãã˜ã‚’é–‹å§‹å‡ºæ¥ã¾ã™",
              updatedAt: serverTimestamp(),
              version: (s.version || 0) + 1,
            },
            { merge: true }
          );
        });
      }

      // å…¨éƒ¨åˆæœŸåŒ–ï¼ˆMasterã¯æ®‹ã™ï¼‰
      async function resetAll() {
        await setDoc(
          roomRef,
          {
            list: [],
            history: [],
            roundBuffer: [],
            currentPlayer: 0,
            display: "Ready",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
        // MasterãŒã‚ã‚Œã°è‡ªå‹•ã§Listã¸å±•é–‹
        await autoPopulateFromMasterIfNeeded();
      }

      async function setPlayers(n) {
        n = clamp(Number(n), 1, 7);
        await setDoc(
          roomRef,
          {
            maxPlayers: n,
            currentPlayer: 0, // äººæ•°å¤‰æ›´æ™‚ã¯æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰å…ˆé ­ã¸
            display: `ğŸ‘¥ Players = ${n} (next is 1)`,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      }

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      function validateInput(input, min, max, errorElementId) {
        const value = Number(input.value);
        const errorEl = document.getElementById(errorElementId);
        
        if (value < min || value > max) {
          input.classList.add("border-red-500");
          if (errorEl) {
            errorEl.textContent = `${min}ã‹ã‚‰${max}ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„`;
            errorEl.classList.remove("hidden");
          }
          return false;
        } else {
          input.classList.remove("border-red-500");
          if (errorEl) {
            errorEl.textContent = "";
            errorEl.classList.add("hidden");
          }
          return true;
        }
      }

      // ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™ã‚’é©ç”¨
      async function applyLimits() {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const isValid = validateInput(maxDrawsPerRoundInput, 0, 20, "drawLimitError");
        
        if (!isValid) {
          alert("å…¥åŠ›å€¤ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        
        const maxDrawsPerRound = clamp(Number(maxDrawsPerRoundInput.value || 0), 0, 20);
        
        await setDoc(
          roomRef,
          { 
            maxTopics: 10, // å›ºå®šå€¤
            maxDrawsPerRound,
            updatedAt: serverTimestamp() 
          },
          { merge: true }
        );
        alert("ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶é™ã‚’é©ç”¨ã—ã¾ã—ãŸ");
      }

      // ãŠé¡Œæ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
      function checkTopicsLimit(currentCount, maxCount) {
        if (currentCount >= maxCount) {
          throw new Error(`ãŠé¡Œæ•°ãŒä¸Šé™ï¼ˆ${maxCount}ä»¶ï¼‰ã«é”ã—ã¦ã„ã¾ã™ã€‚æ—¢å­˜ã®ãŠé¡Œã‚’å‰Šé™¤ã™ã‚‹ã‹ã€ä¸Šé™ã‚’ä¸Šã’ã¦ãã ã•ã„ã€‚`);
        }
      }


      // æŠ½é¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
      function updateDrawButtonState(remainingCount, maxDrawsPerRound, currentDraws) {
        if (!drawBtn) return;
        
        let buttonText = "ğŸ² 1ä»¶ å¼•ã";
        let isDisabled = false;
        
        if (remainingCount === 0) {
          buttonText = "âŒ ãŠé¡ŒãŒã‚ã‚Šã¾ã›ã‚“";
          isDisabled = true;
        } else if (maxDrawsPerRound > 0 && currentDraws >= maxDrawsPerRound) {
          buttonText = `ğŸš« ãƒ©ã‚¦ãƒ³ãƒ‰ä¸Šé™é”æˆ (${currentDraws}/${maxDrawsPerRound})`;
          isDisabled = true;
        } else if (maxDrawsPerRound > 0) {
          buttonText = `ğŸ² 1ä»¶ å¼•ã (${currentDraws}/${maxDrawsPerRound})`;
        }
        
        drawBtn.textContent = buttonText;
        
        if (isDisabled) {
          drawBtn.classList.add("disabled");
          drawBtn.setAttribute("aria-disabled", "true");
          drawBtn.style.cursor = "not-allowed";
          drawBtn.style.opacity = "0.6";
          drawBtn.title = buttonText.replace(/ğŸš«|âŒ/, ''); // çµµæ–‡å­—ã‚’é™¤ã„ãŸèª¬æ˜ã‚’ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã«
        } else {
          drawBtn.classList.remove("disabled");
          drawBtn.removeAttribute("aria-disabled");
          drawBtn.style.cursor = "";
          drawBtn.style.opacity = "";
          drawBtn.title = "";
        }
      }

      // Masterç™»éŒ² â†’ è‡ªå‹•ã§Listã¸å±•é–‹
      async function applyMaster() {
        const text = masterInput.value || "";
        const master = text
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter(Boolean);
        
        // åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆå›ºå®šä¸Šé™10å€‹ï¼‰
        try {
          checkTopicsLimit(master.length, 10);
        } catch (error) {
          alert(error.message);
          return;
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        saveMasterToStorage(master);
        updateMasterDisplay(master);
        
        await setDoc(
          roomRef,
          { master, updatedAt: serverTimestamp() },
          { merge: true }
        );
        await autoPopulateFromMasterIfNeeded();
        alert("Masterã‚’ç™»éŒ²ã—ã€Listã¸è‡ªå‹•å±•é–‹ã—ã¾ã—ãŸ");
      }

      // ==== åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾Œã«UIã‚’èµ·å‹• ====
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          if (authStateEl) authStateEl.textContent = "Signing in (anonymous)...";
          await signInAnonymously(auth).catch((e) => {
            if (authStateEl) authStateEl.textContent = "Anonymous sign-in failed: " + e.message;
          });
          return;
        }

        if (authStateEl) authStateEl.textContent = `Signed in (uid: ${user.uid.slice(0, 6)}â€¦)`;
        enableControls(true);

        await ensureRoom();
        await autoPopulateFromMasterIfNeeded();

        // åˆæœŸè¡¨ç¤ºã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰masterèª­ã¿è¾¼ã¿
        const storedMaster = loadMasterFromStorage();
        updateMasterDisplay(storedMaster);

        onSnapshot(roomRef, (snap) => {
          if (!snap.exists()) {
            console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“");
            return;
          }
          const s = snap.data();
          console.log("Firestore ãƒ‡ãƒ¼ã‚¿æ›´æ–°:", s);

          if (displayEl) displayEl.textContent = s.display || "Ready";
          if (playersView) playersView.textContent = s.maxPlayers ?? "-";
          const currentPlayerNum = (s.currentPlayer % (s.maxPlayers || 4)) + 1;
          if (currentView) currentView.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${currentPlayerNum}`;
          const remainingCount = s.list?.length ?? 0;
          console.log("æ®‹ã‚Šå€‹æ•°æ›´æ–°:", remainingCount, "ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:", s.list, "remainViewè¦ç´ :", remainView);
          if (remainView) {
            remainView.textContent = String(remainingCount);
            console.log("remainViewè¦ç´ ã«è¨­å®šã—ãŸå€¤:", remainView.textContent);
          } else {
            console.error("remainViewè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          // åˆ¶é™æƒ…å ±ã®è¡¨ç¤ºæ›´æ–°
          const maxDrawsPerRound = s.maxDrawsPerRound ?? 0;
          const currentDrawsInRound = s.roundBuffer?.length ?? 0;
          
          // è¨­å®šç”»é¢ã®å…¥åŠ›å€¤ã‚’æ›´æ–°
          if (maxDrawsPerRoundInput) maxDrawsPerRoundInput.value = maxDrawsPerRound;
          
          // æŠ½é¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹åˆ¶å¾¡
          updateDrawButtonState(remainingCount, maxDrawsPerRound, currentDrawsInRound);

          // Firebaseã‹ã‚‰masterãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨UIæ›´æ–°
          if (s.master && s.master.length > 0) {
            saveMasterToStorage(s.master);
            updateMasterDisplay(s.master);
          } else {
            // Firebaseã«masterãŒãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒè¡¨ç¤º
            const stored = loadMasterFromStorage();
            updateMasterDisplay(stored);
          }

          // Stateè¡¨ç¤ºã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ã“ã®å‡¦ç†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          // document.getElementById(
          //   "state"
          // ).textContent = `Auth: Signed in / version:${
          //   s.version ?? 0
          // } / updated:${s.updatedAt?.toDate?.().toLocaleString?.() ?? "-"}`;
        });

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        drawBtn.onclick = () => drawOne().catch((e) => alert(e.message));
        ackBtn.onclick = () => acknowledgeDisplay();
        resetRoundBtn.onclick = () => showConfirmModal(); // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã«å¤‰æ›´
        resetAllBtn.onclick = () => resetAll();
        applyMasterBtn.onclick = () => applyMaster().catch((e) => alert(e.message));
        applyLimitsBtn.onclick = () => applyLimits().catch((e) => alert(e.message));
        playerBtns.forEach((btn) => {
          btn.onclick = () => setPlayers(btn.getAttribute("data-setp"));
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        maxDrawsPerRoundInput.addEventListener('input', () => validateInput(maxDrawsPerRoundInput, 0, 20, "drawLimitError"));

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã“ã“ã§è¨­å®šï¼ˆresetRoundé–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ï¼‰
        document.getElementById('cancelReset').addEventListener('click', hideConfirmModal);
        document.getElementById('confirmReset').addEventListener('click', async function() {
          hideConfirmModal();
          try {
            await resetRound(); // resetRoundé–¢æ•°ãŒå‚ç…§å¯èƒ½
          } catch (error) {
            console.error('ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            alert('ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
          }
        });
      });
    </script>
  </body>
</html>
