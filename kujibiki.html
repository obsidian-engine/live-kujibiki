<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>é…ä¿¡ç”¨ãã˜å¼•ãï¼ˆé™çš„ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  / åŒ¿åAuthï¼‰</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      body {
        margin: 16px;
      }
      h1 {
        margin: 0 0 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      textarea {
        width: 320px;
        height: 140px;
      }
      button {
        padding: 8px 12px;
      }
      #display {
        margin-top: 12px;
        padding: 16px;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-size: 48px;
        font-weight: 800;
        text-align: center;
        min-height: 90px;
      }
      #state {
        font-size: 12px;
        color: #666;
      }
      .panel {
        border: 1px solid #eee;
        padding: 12px;
        border-radius: 12px;
      }
      .pill {
        padding: 2px 8px;
        border: 1px solid #ccc;
        border-radius: 999px;
        font-size: 12px;
      }
      .muted {
        color: #777;
        font-size: 12px;
      }
      .disabled {
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ² é…ä¿¡ç”¨ãã˜å¼•ãï¼ˆé™çš„ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  / åŒ¿åAuthï¼‰</h1>
    <div id="state">Auth: <span id="authState">Signing in...</span></div>

    <div class="row">
      <div class="panel col">
        <div class="row">
          <div class="pill">Room: <span id="roomIdView">-</span></div>
          <div class="pill">Players: <span id="playersView">-</span></div>
          <div class="pill">Current: <span id="currentView">-</span></div>
          <div class="pill">Remaining: <span id="remainView">-</span></div>
        </div>

        <div class="row">
          <button id="drawBtn" class="disabled">1ä»¶ å¼•ã</button>
          <button id="ackBtn" class="disabled">
            ãŠé¡Œã‚’ç¢ºèªã—ã¾ã—ãŸï¼ˆéè¡¨ç¤ºã«ã™ã‚‹ï¼‰
          </button>
          <button id="resetRoundBtn" class="disabled">
            ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æˆ»ã™
          </button>
          <button
            id="resetAllBtn"
            class="disabled"
            style="background: #fee; border: 1px solid #f88"
          >
            å…¨éƒ¨åˆæœŸåŒ–
          </button>
        </div>

        <div class="row">
          <button data-setp="4" class="disabled">4äººã«ã™ã‚‹</button>
          <button data-setp="5" class="disabled">5äººã«ã™ã‚‹</button>
          <button data-setp="6" class="disabled">6äººã«ã™ã‚‹</button>
          <button data-setp="7" class="disabled">7äººã«ã™ã‚‹</button>
        </div>

        <div id="display">Ready</div>
      </div>

      <div class="panel col">
        <div class="muted">
          åˆå›ã ã‘Masterã«7ä»¶ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚<br />â€»
          Masterå…¥åŠ›å¾Œã¯è‡ªå‹•ã§Listã¸å±•é–‹ã•ã‚Œã¾ã™ã€‚
        </div>
        <textarea
          id="masterInput"
          placeholder="ï¼ˆä¾‹ï¼‰&#10;ãƒªãƒ¼ãƒã‚’ã‹ã‘ã‚‹&#10;é³´ã‹ãªã„&#10;å­—ç‰Œã‚’ä½¿ã†&#10;ãƒ‰ãƒ©ã‚’ä½¿ã†&#10;ãƒ”ãƒ³ãƒ•ã§ã‚ãŒã‚‹&#10;ã‚¿ãƒ³ãƒ¤ã‚ªã§ã‚ãŒã‚‹&#10;2å›ä»¥ä¸Šé³´ã"
        ></textarea>
        <div class="row">
          <button id="applyMasterBtn" class="disabled">
            Masterã‚’ç™»éŒ²ï¼ˆè‡ªå‹•å±•é–‹ï¼‰
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        onSnapshot,
        runTransaction,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

      const firebaseConfig = {
        apiKey: import.meta.env.VITE_FIREBASE_API_KEY || "",
        authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN || "",
        projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID || "",
        storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET || "",
        messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID || "",
        appId: import.meta.env.VITE_FIREBASE_APP_ID || "",
        measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID || "",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const qs = new URLSearchParams(location.search);
      const roomId = (qs.get("room") || "demo-room").trim();
      document.getElementById("roomIdView").textContent = roomId;
      const roomRef = doc(db, "rooms", roomId);

      const DEFAULT_STATE = {
        master: [],
        list: [],
        history: [],
        currentPlayer: 0,
        maxPlayers: 4,
        roundBuffer: [],
        display: "Ready",
        updatedAt: serverTimestamp(),
        version: 0,
      };

      function clamp(v, lo, hi) {
        return Math.min(hi, Math.max(lo, v));
      }

      async function ensureRoom() {
        const snap = await getDoc(roomRef);
        if (!snap.exists()) {
          await setDoc(roomRef, DEFAULT_STATE);
        }
      }

      // â˜… MasterãŒã‚ã‚ŠListãŒç©ºãªã‚‰è‡ªå‹•å±•é–‹ï¼ˆMasterâ†’Listï¼‰
      async function autoPopulateFromMasterIfNeeded() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          if (!snap.exists()) return;
          const s = snap.data();
          const master = s.master || [];
          const list = s.list || [];
          if (master.length > 0 && list.length === 0) {
            tx.set(
              roomRef,
              {
                ...s,
                list: [...master],
                roundBuffer: [],
                currentPlayer: 0, // æ¬¡ã¯Player1ã‹ã‚‰ï¼ˆãƒœã‚¿ãƒ³ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
                display: "Ready",
                updatedAt: serverTimestamp(),
                version: (s.version || 0) + 1,
              },
              { merge: true }
            );
          }
        });
      }

      // ==== UIå‚ç…§ ====
      const authStateEl = document.getElementById("authState");
      const displayEl = document.getElementById("display");
      const playersView = document.getElementById("playersView");
      const currentView = document.getElementById("currentView");
      const remainView = document.getElementById("remainView");

      const drawBtn = document.getElementById("drawBtn");
      const ackBtn = document.getElementById("ackBtn");
      const resetRoundBtn = document.getElementById("resetRoundBtn");
      const resetAllBtn = document.getElementById("resetAllBtn");
      const masterInput = document.getElementById("masterInput");
      const applyMasterBtn = document.getElementById("applyMasterBtn");
      const playerBtns = Array.from(document.querySelectorAll("[data-setp]"));

      function enableControls(enabled) {
        const method = enabled ? "remove" : "add";
        [
          drawBtn,
          ackBtn,
          resetRoundBtn,
          resetAllBtn,
          applyMasterBtn,
          ...playerBtns,
        ].forEach((el) => el.classList[method]("disabled"));
      }

      // ==== Firestore Actions ====
      async function drawOne() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          const s = snap.exists() ? snap.data() : DEFAULT_STATE;

          let list = [...(s.list || [])];
          if (list.length === 0)
            throw new Error("ListãŒç©ºã§ã™ã€‚Masterã¸ãŠé¡Œã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚");

          const maxP = clamp(Number(s.maxPlayers || 4), 1, 7);
          let current = Number(s.currentPlayer || 0);
          current = (current % maxP) + 1;

          const idx = Math.floor(Math.random() * list.length);
          const picked = list.splice(idx, 1)[0];

          const roundBuffer = [...(s.roundBuffer || []), picked];
          const history = [
            { t: new Date(), player: current, picked },
            ...(s.history || []),
          ].slice(0, 200);

          let display = `ğŸ® Player ${current} â†’ ${picked}`;
          let currentPlayer = current;
          let listAfter = list;
          let roundBufAfter = roundBuffer;

          if (current === maxP) {
            // Nå›ã§1ã‚²ãƒ¼ãƒ  â†’ æ¸›ã£ãŸåˆ†ã‚’å¾©å…ƒã—ã¦æ¬¡ã¯1ã¸
            listAfter = [...list, ...roundBuffer];
            roundBufAfter = [];
            currentPlayer = 0;
            display = `ğŸ” Round Reset â€” last: Player ${current} â†’ ${picked}`;
          }

          tx.set(
            roomRef,
            {
              ...s,
              list: listAfter,
              roundBuffer: roundBufAfter,
              history,
              currentPlayer,
              display,
              updatedAt: serverTimestamp(),
              version: (s.version || 0) + 1,
            },
            { merge: true }
          );
        });
      }

      // ã€ŒãŠé¡Œã‚’ç¢ºèªã—ã¾ã—ãŸã€â†’ è¡¨ç¤ºã‚’æ¶ˆã™ï¼ˆä¸­èº«ã¯ãã®ã¾ã¾ï¼‰
      async function acknowledgeDisplay() {
        await setDoc(
          roomRef,
          {
            display: "ï¼ˆç¢ºèªæ¸ˆãƒ»éè¡¨ç¤ºï¼‰",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      }

      // ãƒ©ã‚¦ãƒ³ãƒ‰æ‰‹å‹•å¾©å…ƒ
      async function resetRound() {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(roomRef);
          const s = snap.exists() ? snap.data() : DEFAULT_STATE;
          const restored = [...(s.list || []), ...(s.roundBuffer || [])];
          tx.set(
            roomRef,
            {
              ...s,
              list: restored,
              roundBuffer: [],
              currentPlayer: 0,
              display: "ğŸ” Round Reset (Manual)",
              updatedAt: serverTimestamp(),
              version: (s.version || 0) + 1,
            },
            { merge: true }
          );
        });
      }

      // å…¨éƒ¨åˆæœŸåŒ–ï¼ˆMasterã¯æ®‹ã™ï¼‰
      async function resetAll() {
        await setDoc(
          roomRef,
          {
            list: [],
            history: [],
            roundBuffer: [],
            currentPlayer: 0,
            display: "Ready",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
        // MasterãŒã‚ã‚Œã°è‡ªå‹•ã§Listã¸å±•é–‹
        await autoPopulateFromMasterIfNeeded();
      }

      async function setPlayers(n) {
        n = clamp(Number(n), 1, 7);
        await setDoc(
          roomRef,
          {
            maxPlayers: n,
            currentPlayer: 0, // äººæ•°å¤‰æ›´æ™‚ã¯æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰å…ˆé ­ã¸
            display: `ğŸ‘¥ Players = ${n} (next is 1)`,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      }

      // Masterç™»éŒ² â†’ è‡ªå‹•ã§Listã¸å±•é–‹
      async function applyMaster() {
        const text = masterInput.value || "";
        const master = text
          .split(/\r?\n/)
          .map((s) => s.trim())
          .filter(Boolean);
        await setDoc(
          roomRef,
          { master, updatedAt: serverTimestamp() },
          { merge: true }
        );
        await autoPopulateFromMasterIfNeeded();
        alert("Masterã‚’ç™»éŒ²ã—ã€Listã¸è‡ªå‹•å±•é–‹ã—ã¾ã—ãŸ");
      }

      // ==== åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³å¾Œã«UIã‚’èµ·å‹• ====
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          authStateEl.textContent = "Signing in (anonymous)...";
          await signInAnonymously(auth).catch((e) => {
            authStateEl.textContent = "Anonymous sign-in failed: " + e.message;
          });
          return;
        }

        authStateEl.textContent = `Signed in (uid: ${user.uid.slice(0, 6)}â€¦)`;
        enableControls(true);

        await ensureRoom();
        await autoPopulateFromMasterIfNeeded();

        onSnapshot(roomRef, (snap) => {
          if (!snap.exists()) return;
          const s = snap.data();

          displayEl.textContent = s.display || "Ready";
          playersView.textContent = s.maxPlayers ?? "-";
          currentView.textContent = (s.currentPlayer % (s.maxPlayers || 4)) + 1;
          remainView.textContent = s.list?.length ?? 0;

          document.getElementById(
            "state"
          ).textContent = `Auth: Signed in / version:${
            s.version ?? 0
          } / updated:${s.updatedAt?.toDate?.().toLocaleString?.() ?? "-"}`;
        });

        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        drawBtn.onclick = () => drawOne().catch((e) => alert(e.message));
        ackBtn.onclick = () => acknowledgeDisplay();
        resetRoundBtn.onclick = () => resetRound();
        resetAllBtn.onclick = () => resetAll();
        applyMasterBtn.onclick = () => applyMaster();
        playerBtns.forEach((btn) => {
          btn.onclick = () => setPlayers(btn.getAttribute("data-setp"));
        });
      });
    </script>
  </body>
</html>
